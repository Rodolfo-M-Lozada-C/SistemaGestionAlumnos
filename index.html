<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gestión de Alumnos y Cupos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
  <!-- CDN para SheetJS (librería para exportar a Excel) -->
  <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

  <!-- ¡INICIO DE LA INTEGRACIÓN DE FIREBASE! -->
  <!-- Script para inicializar Firebase y Firestore (SDK modular) -->
  <script type="module">
    // Importa las funciones necesarias del SDK de Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      where,
      orderBy
    } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    // Tu configuración de Firebase (¡REEMPLAZA ESTO CON TUS PROPIOS VALORES!)
    const firebaseConfig = {
      apiKey: "AIzaSyDE6NyA2cqD3oqBicBASGC-ZTYX4RvCsew", // <--- ¡TU API KEY AQUÍ!
      authDomain: "sae-sistema-expedientes.firebaseapp.com", // <--- ¡TU AUTH DOMAIN AQUÍ!
      projectId: "sae-sistema-expedientes", // <--- ¡TU PROJECT ID AQUÍ!
      storageBucket: "sae-sistema-expedientes.firebasestorage.app", // <--- ¡TU STORAGE BUCKET AQUÍ!
      messagingSenderId: "708202904069", // <--- ¡TU MESSAGING SENDER ID AQUÍ!
      appId: "1:708202904069:web:5adfe1416703df65b63a6c" // <--- ¡TU APP ID AQUÍ!
    };

    // Inicializa Firebase
    const app = initializeApp(firebaseConfig);

    // Obtén una referencia a la base de datos Firestore
    const db = getFirestore(app);

    console.log("Firebase y Firestore inicializados con SDK modular!");

    // Hacemos las referencias de Firebase globales para que tu script principal pueda acceder a ellas.
    // Esto es una solución común para un solo archivo HTML sin un sistema de módulos completo.
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.onSnapshot = onSnapshot;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
  </script>
  <!-- ¡FIN DE LA INTEGRACIÓN DE FIREBASE! -->

  <style>
    :root {
      --primary-color: #6f42c1; /* Morado */
      --secondary-color: #6c757d; /* Gris */
      --success-color: #28a745; /* Verde */
      --info-color: #17a2b8; /* Azul claro */
      --warning-color: #ffc107; /* Amarillo */
      --danger-color: #dc3545; /* Rojo */
      --light-bg: #f8f9fa;
      --dark-text: #343a40;
      --card-bg: #ffffff;
    }

    body {
      font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: var(--light-bg);
      color: var(--dark-text);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin-top: 30px;
      margin-bottom: 30px;
    }

    h1 {
      color: var(--primary-color);
      font-weight: 700;
      margin-bottom: 30px;
      text-align: center;
      position: relative;
    }
    h1::after {
      content: '';
      display: block;
      width: 80px;
      height: 4px;
      background-color: var(--primary-color);
      margin: 15px auto 0;
      border-radius: 2px;
    }

    .card {
      border-radius: 15px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      border: none;
      background-color: var(--card-bg);
      margin-bottom: 25px;
    }

    .card-header {
      border-radius: 15px 15px 0 0 !important;
      font-size: 1.35rem;
      font-weight: 600;
      padding: 1.25rem 1.5rem;
      color: white;
      background-color: var(--primary-color); /* Default header color */
      border-bottom: none;
    }
    .card-header.bg-primary { background-color: var(--primary-color) !important; }
    .card-header.bg-success { background-color: var(--success-color) !important; }
    .card-header.bg-info { background-color: var(--info-color) !important; }
    .card-header.bg-secondary { background-color: var(--secondary-color) !important; }


    .nav-tabs {
      border-bottom: 2px solid var(--primary-color);
      margin-bottom: 25px;
    }
    .nav-tabs .nav-link {
      color: var(--dark-text);
      border: none;
      border-bottom: 3px solid transparent;
      padding: 12px 20px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .nav-tabs .nav-link:hover {
      color: var(--primary-color);
      border-color: var(--primary-color);
    }
    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      background-color: transparent;
      border-color: var(--primary-color);
      font-weight: 600;
    }

    .form-group-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .form-group-full {
      grid-column: 1 / -1;
    }

    .form-control, .form-select {
      border-radius: 8px;
      border: 1px solid #ced4da;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(111, 66, 193, 0.25); /* primary-color with alpha */
    }

    .btn {
      border-radius: 8px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-primary:hover { background-color: #5a36a3; border-color: #5a36a3; } /* Darker primary */
    .btn-info { background-color: var(--info-color); border-color: var(--info-color); }
    .btn-info:hover { background-color: #138496; border-color: #138496; } /* Darker info */
    .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); color: var(--dark-text); }
    .btn-warning:hover { background-color: #e0a800; border-color: #e0a800; }
    .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
    .btn-danger:hover { background-color: #bd2130; border-color: #bd2130; }
    .btn-secondary { background-color: var(--secondary-color); border-color: var(--secondary-color); }
    .btn-secondary:hover { background-color: #545b62; border-color: #545b62; }

    .table {
      margin-top: 15px;
      border-radius: 10px;
      overflow: hidden; /* Ensures rounded corners for table */
    }
    .table thead th {
      background-color: var(--primary-color);
      color: white;
      border-bottom: none;
      padding: 1rem;
    }
    .table tbody tr:nth-of-type(odd) {
      background-color: rgba(0,0,0,.03);
    }
    .table tbody tr:hover {
      background-color: rgba(111, 66, 193, 0.1); /* Light hover effect */
    }
    .table td, .table th {
      vertical-align: middle;
      border-top: 1px solid #dee2e6;
      padding: 0.85rem;
    }

    /* Autocomplete styles */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
      background-color: var(--card-bg);
      border-radius: 0 0 8px 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: var(--card-bg);
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.2s ease;
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }
    .autocomplete-active {
      background-color: var(--primary-color) !important;
      color: #ffffff;
    }
    .autocomplete-active strong {
      color: #ffffff;
    }

    /* Estilos para las fechas seleccionadas */
    .fecha-tag {
      display: inline-block;
      background-color: var(--primary-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      margin: 5px;
      font-size: 0.9em;
    }
    .fecha-tag .btn-close-tag {
      background: none;
      border: none;
      color: white;
      font-size: 0.8em;
      margin-left: 5px;
      cursor: pointer;
    }

    /* Estilos para los toasts */
    .toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1080; /* Higher than modals */
    }
    .toast {
      border-radius: 0.5rem;
      box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
      border: none;
    }
    .toast-header {
      border-bottom: none;
      font-weight: 600;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem 0.5rem 0 0;
    }
    .toast-body {
      padding: 1rem;
      color: var(--dark-text);
    }
    .toast.bg-success .toast-header { background-color: var(--success-color); }
    .toast.bg-danger .toast-header { background-color: var(--danger-color); }
    .toast.bg-info .toast-header { background-color: var(--info-color); }
    .toast.bg-warning .toast-header { background-color: var(--warning-color); color: var(--dark-text); }
    .toast-header .btn-close {
      filter: invert(1) grayscale(100%) brightness(200%); /* Make close button white */
    }

    /* Ajuste para los select de Pago y Kit en el modal */
    #modalAsignarProyecto .form-group-grid > div {
      flex: 1; /* Distribute space evenly */
      min-width: unset; /* Override min-width for smaller selects */
    }
    #modalAsignarProyecto .form-select {
      padding: 0.5rem 0.75rem; /* Make selects smaller */
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fas fa-graduation-cap me-2"></i>Sistema de Gestión de Alumnos y Cupos</h1>

    <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button" role="tab" aria-controls="registro" aria-selected="true">
          <i class="fas fa-user-plus me-2"></i>Registro de Alumnos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="lista-tab" data-bs-toggle="tab" data-bs-target="#lista" type="button" role="tab" aria-controls="lista" aria-selected="false">
          <i class="fas fa-users me-2"></i>Alumnos Inscritos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="plantilla-tab" data-bs-toggle="tab" data-bs-target="#plantilla" type="button" role="tab" aria-controls="plantilla" aria-selected="false">
          <i class="fas fa-address-book me-2"></i>Alumnos Registrados
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="cupos-tab" data-bs-toggle="tab" data-bs-target="#cupos" type="button" role="tab" aria-controls="cupos" aria-selected="false">
          <i class="fas fa-calendar-alt me-2"></i>Cupos
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="profesores-tab" data-bs-toggle="tab" data-bs-target="#profesores" type="button" role="tab" aria-controls="profesores" aria-selected="false">
          <i class="fas fa-chalkboard-teacher me-2"></i>Profesores
        </button>
      </li>
      <!-- Nueva pestaña para Proyectos -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="proyectos-tab" data-bs-toggle="tab" data-bs-target="#proyectos" type="button" role="tab" aria-controls="proyectos" aria-selected="false">
          <i class="fas fa-project-diagram me-2"></i>Proyectos
        </button>
      </li>
      <!-- Nueva pestaña para Reportes -->
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="reportes-tab" data-bs-toggle="tab" data-bs-target="#reportes" type="button" role="tab" aria-controls="reportes" aria-selected="false">
          <i class="fas fa-chart-bar me-2"></i>Reportes
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      <!-- Registro de Alumnos -->
      <div class="tab-pane fade show active" id="registro" role="tabpanel" aria-labelledby="registro-tab">
        <div class="card">
          <div class="card-header bg-primary text-white"><i class="fas fa-user-plus me-2"></i>Registro de Alumnos</div>
          <div class="card-body">
            <form id="alumnoForm">
              <input type="hidden" id="idAlumnoEditando">
              <input type="hidden" id="idAlumnoPlantilla">

              <div class="mb-4">
                <label for="buscarAlumno" class="form-label fw-bold">Buscar Alumno Existente para Reinscripción</label>
                <div class="position-relative">
                  <input type="text" class="form-control" id="buscarAlumno" placeholder="Buscar por nombre o correo electrónico">
                  <div id="autocompleteList" class="autocomplete-items"></div>
                </div>
                <small class="form-text text-muted">Empieza a escribir para buscar alumnos registrados previamente.</small>
              </div>

              <div class="form-group-grid">
                <div><label for="nombre" class="form-label">Nombre Completo</label><input type="text" class="form-control" id="nombre" required></div>
                <div><label for="nivel" class="form-label">Nivel</label>
                  <select class="form-select" id="nivel" required>
                    <option value="">Seleccione</option>
                    <option value="De cero">De cero</option>
                    <option value="Basico">Básico</option>
                    <option value="Intermedio">Intermedio</option>
                    <option value="Avanzado">Avanzado</option>
                  </select>
                </div>
                <div><label for="telefono" class="form-label">Teléfono</label><input type="tel" class="form-control" id="telefono" required></div>
                <div><label for="correo" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="correo" required></div>
                <div><label for="estatus" class="form-label">Estatus</label>
                  <select class="form-select" id="estatus" required>
                    <option value="">Seleccione</option>
                    <option value="Recurrente">Recurrente</option>
                    <option value="Nuevo">Nuevo</option>
                    <option value="Ya no asiste">Ya no asiste</option>
                  </select>
                </div>
                <!-- El select de horario se ha movido al modal de "Alumnos Inscritos" -->
              </div>
              <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button type="submit" class="btn btn-primary" id="btnRegistrarAlumno"><i class="fas fa-save me-2"></i>Registrar Alumno</button>
                <button type="button" class="btn btn-secondary" id="btnLimpiarAlumnoForm"><i class="fas fa-eraser me-2"></i>Limpiar Formulario</button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Lista de Alumnos Inscritos (Activos en un cupo) -->
      <div class="tab-pane fade" id="lista" role="tabpanel" aria-labelledby="lista-tab">
        <div class="card">
          <div class="card-header bg-success text-white"><i class="fas fa-users me-2"></i>Alumnos Inscritos (Activos en un Cupo)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Nivel</th>
                    <th>Horario</th>
                    <th>Proyecto Asignado</th>
                    <th>Pago</th> <!-- Nueva columna -->
                    <th>Kit</th> <!-- Nueva columna -->
                    <th>Observaciones</th>
                    <th>Estatus</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="listaAlumnos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de Alumnos Registrados (Plantilla) -->
      <div class="tab-pane fade" id="plantilla" role="tabpanel" aria-labelledby="plantilla-tab">
        <div class="card">
          <div class="card-header bg-secondary text-white"><i class="fas fa-address-book me-2"></i>Alumnos Registrados (Plantilla)</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Nivel Preferido</th>
                    <th>Observaciones</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="listaPlantillaAlumnos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Cupos -->
      <div class="tab-pane fade" id="cupos" role="tabpanel" aria-labelledby="cupos-tab">
        <div class="card mb-4">
          <div class="card-header bg-primary text-white"><i class="fas fa-calendar-plus me-2"></i>Registro de Nuevos Cupos</div>
          <div class="card-body">
            <form id="cupoForm">
              <div class="form-group-grid">
                <div><label for="profesorSelect" class="form-label">Profesor</label>
                  <select class="form-select" id="profesorSelect" required>
                    <option value="">Seleccione un profesor</option>
                  </select>
                </div>
                <div>
                  <label for="fechaCupoIndividual" class="form-label">Añadir Fechas</label>
                  <div class="input-group">
                    <input type="date" class="form-control" id="fechaCupoIndividual">
                    <button class="btn btn-outline-secondary" type="button" id="btnAddFechaCupo"><i class="fas fa-plus"></i> Añadir</button>
                  </div>
                  <div id="fechasSeleccionadasContainer" class="mt-2">
                    <!-- Aquí se mostrarán las fechas seleccionadas -->
                  </div>
                  <input type="hidden" id="fechasCupoHidden" required> <!-- Campo oculto para el submit -->
                </div>
                <div><label for="horaInicio" class="form-label">Hora Inicio</label><input type="time" class="form-control" id="horaInicio" required></div>
                <div><label for="horaFin" class="form-label">Hora Fin</label><input type="time" class="form-control" id="horaFin" required></div>
                <div><label for="cupoMax" class="form-label">Cupo (Máx. Personas)</label><input type="number" class="form-control" id="cupoMax" required min="1"></div>
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle me-2"></i>Registrar Cupo</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-success text-white"><i class="fas fa-list-alt me-2"></i>Lista de Cupos Disponibles</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Profesor</th>
                    <th>Fechas</th> <!-- Cambiado a Fechas -->
                    <th>Horario</th>
                    <th>Cupo Disponible</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="listaCupos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Profesores -->
      <div class="tab-pane fade" id="profesores" role="tabpanel" aria-labelledby="profesores-tab">
        <div class="card mb-4">
          <div class="card-header bg-info text-white"><i class="fas fa-user-tie me-2"></i>Registro de Profesores</div>
          <div class="card-body">
            <form id="profesorForm">
              <input type="hidden" id="idProfesorEditando">
              <div class="form-group-grid">
                <div><label for="nombreProfesor" class="form-label">Nombre Completo</label><input type="text" class="form-control" id="nombreProfesor" required></div>
                <div><label for="correoProfesor" class="form-label">Correo Electrónico</label><input type="email" class="form-control" id="correoProfesor" required></div>
                <div><label for="telefonoProfesor" class="form-label">Teléfono</label><input type="tel" class="form-control" id="telefonoProfesor"></div>
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-info" id="btnRegistrarProfesor"><i class="fas fa-user-plus me-2"></i>Registrar Profesor</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-success text-white"><i class="fas fa-users-cog me-2"></i>Lista de Profesores</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Correo</th>
                    <th>Teléfono</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="listaProfesores"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Proyectos -->
      <div class="tab-pane fade" id="proyectos" role="tabpanel" aria-labelledby="proyectos-tab">
        <div class="card mb-4">
          <div class="card-header bg-info text-white"><i class="fas fa-folder-plus me-2"></i>Registro de Proyectos</div>
          <div class="card-body">
            <form id="proyectoForm">
              <input type="hidden" id="idProyectoEditando">
              <div class="form-group-grid">
                <div><label for="nombreProyecto" class="form-label">Nombre del Proyecto</label><input type="text" class="form-control" id="nombreProyecto" required></div>
              </div>
              <div class="d-grid mt-4">
                <button type="submit" class="btn btn-info" id="btnRegistrarProyecto"><i class="fas fa-save me-2"></i>Registrar Proyecto</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-success text-white"><i class="fas fa-list-alt me-2"></i>Lista de Proyectos</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="listaProyectos"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Reportes -->
      <div class="tab-pane fade" id="reportes" role="tabpanel" aria-labelledby="reportes-tab">
        <div class="card mb-4">
          <div class="card-header bg-info text-white"><i class="fas fa-filter me-2"></i>Filtros de Reporte</div>
          <div class="card-body">
            <div class="form-group-grid">
              <div>
                <label for="reportProfesorFilter" class="form-label">Profesor</label>
                <select class="form-select" id="reportProfesorFilter">
                  <option value="">Todos</option>
                </select>
              </div>
              <div>
                <label for="reportProyectoFilter" class="form-label">Proyecto</label>
                <select class="form-select" id="reportProyectoFilter">
                  <option value="">Todos</option>
                </select>
              </div>
              <div>
                <label for="reportNivelFilter" class="form-label">Nivel</label>
                <select class="form-select" id="reportNivelFilter">
                  <option value="">Todos</option>
                  <option value="De cero">De cero</option>
                  <option value="Basico">Básico</option>
                  <option value="Intermedio">Intermedio</option>
                  <option value="Avanzado">Avanzado</option>
                </select>
              </div>
              <div>
                <label for="reportEstatusFilter" class="form-label">Estatus</label>
                <select class="form-select" id="reportEstatusFilter">
                  <option value="">Todos</option>
                  <option value="Recurrente">Recurrente</option>
                  <option value="Nuevo">Nuevo</option>
                  <option value="Ya no asiste">Ya no asiste</option>
                </select>
              </div>
              <div>
                <label for="reportPagoFilter" class="form-label">Pago</label>
                <select class="form-select" id="reportPagoFilter">
                  <option value="">Todos</option>
                  <option value="Adelanto">Adelanto</option>
                  <option value="50%">50%</option>
                  <option value="100%">100%</option>
                  <option value="N/A">N/A</option>
                </select>
              </div>
              <div>
                <label for="reportKitFilter" class="form-label">Kit</label>
                <select class="form-select" id="reportKitFilter">
                  <option value="">Todos</option>
                  <option value="Completo">Completo</option>
                  <option value="Basico">Básico</option>
                  <option value="N/A">N/A</option>
                </select>
              </div>
            </div>
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
              <button type="button" class="btn btn-primary" id="btnApplyReportFilters"><i class="fas fa-search me-2"></i>Generar Reporte</button>
              <button type="button" class="btn btn-success" id="btnExportExcel" disabled><i class="fas fa-file-excel me-2"></i>Exportar a Excel</button>
              <button type="button" class="btn btn-secondary" id="btnExportJson"><i class="fas fa-file-code me-2"></i>Exportar a JSON</button>
              <button type="button" class="btn btn-info" id="btnImportJson"><i class="fas fa-file-import me-2"></i>Importar JSON</button>
              <input type="file" id="jsonFileInput" accept=".json" style="display: none;">
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header bg-primary text-white"><i class="fas fa-table me-2"></i>Resultados del Reporte</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Nivel</th>
                    <th>Horario</th>
                    <th>Proyecto Asignado</th>
                    <th>Pago</th>
                    <th>Kit</th>
                    <th>Observaciones</th>
                    <th>Estatus</th>
                  </tr>
                </thead>
                <tbody id="reportResults">
                  <tr><td colspan="8" class="text-center">No hay datos para mostrar. Aplique los filtros.</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Modal para Cambiar Horario -->
  <div class="modal fade" id="modalCambiarHorario" tabindex="-1" aria-labelledby="modalCambiarHorarioLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title" id="modalCambiarHorarioLabel"><i class="fas fa-calendar-check me-2"></i>Cambiar Horario del Alumno</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="alumnoIdCambiarHorario">
          <p>Alumno: <strong id="nombreAlumnoCambiarHorario"></strong></p>
          <div class="mb-3">
            <label for="cupoSelectModal" class="form-label">Seleccionar Nuevo Horario</label>
            <select class="form-select" id="cupoSelectModal" required></select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarCambioHorario">Guardar Cambio</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Asignar Proyecto (anteriormente Curso) -->
  <div class="modal fade" id="modalAsignarProyecto" tabindex="-1" aria-labelledby="modalAsignarProyectoLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="modalAsignarProyectoLabel"><i class="fas fa-project-diagram me-2"></i>Asignar Proyecto y Detalles del Alumno</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="alumnoIdAsignarProyecto">
          <p>Alumno: <strong id="nombreAlumnoAsignarProyecto"></strong></p>
          <div class="mb-3">
            <label for="proyectoSelectModal" class="form-label">Seleccionar Proyecto</label>
            <select class="form-select" id="proyectoSelectModal" required>
              <option value="">Sin Proyecto</option>
              <!-- Opciones de proyectos se cargarán dinámicamente aquí -->
            </select>
          </div>
          <div class="form-group-grid mb-3"> <!-- Usamos form-group-grid para Pago y Kit -->
            <div>
              <label for="pagoSelectModal" class="form-label">PAGO</label>
              <select class="form-select" id="pagoSelectModal" required>
                <option value="">Seleccione opción de pago</option>
                <option value="Adelanto">Adelanto</option>
                <option value="50%">50%</option>
                <option value="100%">100%</option>
              </select>
            </div>
            <div>
              <label for="kitSelectModal" class="form-label">KIT</label>
              <select class="form-select" id="kitSelectModal" required>
                <option value="">Seleccione opción de kit</option>
                <option value="Completo">Completo</option>
                <option value="Basico">Básico</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="observacionesModal" class="form-label">Observaciones del Alumno</label>
            <textarea class="form-control" id="observacionesModal" rows="3" placeholder="Notas adicionales (no obligatorio)"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="btnGuardarProyecto">Guardar Proyecto y Detalles</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Contenedor para Toasts (Notificaciones) -->
  <div class="toast-container">
    <!-- Toasts se insertarán aquí dinámicamente -->
  </div>

  <!-- Script de Bootstrap 5 (¡IMPORTANTE!) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- IndexedDB Constants (ELIMINAR ESTAS LÍNEAS) ---
// Estas constantes y la variable 'db' ya no son necesarias si te has movido completamente a Firestore.
// Las dejo comentadas para que sepas qué eliminar.
/*
const DB_NAME = 'RegistroDB';
const DB_VERSION = 13;
let db;
*/

// --- Firestore Collection Names ---
// Define los nombres de tus colecciones en Firestore
const STORE_ALUMNOS_FIRESTORE = "alumnos";
const STORE_CUPOS_FIRESTORE = "cupos";
const STORE_PROFESORES_FIRESTORE = "profesores";
const STORE_PLANTILLA_ALUMNOS_FIRESTORE = "plantillaAlumnos";
const STORE_PROYECTOS_FIRESTORE = "proyectos";


// Variable global para almacenar los alumnos filtrados para la exportación
let lastFilteredAlumnos = [];

// --- IndexedDB Generic Helper Functions (ELIMINAR ESTAS FUNCIONES) ---
// Elimina todas estas funciones relacionadas con IndexedDB.
/*
const openDB = () => new Promise((resolve,reject)=>{ ... });
const addData = (storeName, data) => new Promise((res, rej) => { ... });
const getAllData = (storeName) => new Promise((res, rej) => { ... });
const getDataById = (storeName, id) => new Promise((res, rej) => { ... });
const updateData = (storeName, data) => new Promise((res, rej) => { ... });
const deleteData = (storeName, id) => new Promise((res, rej) => { ... });
const clearStore = (storeName, transaction = null) => new Promise((resolve, reject) => { ... });
*/

// --- Firestore Helper Functions (NUEVO - REEMPLAZAN LAS DE IndexedDB) ---
// Estas funciones usarán las variables globales (window.db, window.collection, etc.)
// que definimos en el script type="module" de arriba.

// --- ALUMNOS (Firestore) ---
const addAlumnoFirestore = async (alumnoData) => {
  try {
    const docRef = await window.addDoc(window.collection(window.db, STORE_ALUMNOS_FIRESTORE), alumnoData);
    console.log("Documento de alumno escrito con ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Error al añadir documento de alumno: ", e);
    throw e;
  }
};

const getAlumnosFirestore = async () => {
  try {
    const querySnapshot = await window.getDocs(window.collection(window.db, STORE_ALUMNOS_FIRESTORE));
    const alumnos = [];
    querySnapshot.forEach(doc => {
      alumnos.push({ id: doc.id, ...doc.data() });
    });
    return alumnos;
  } catch (e) {
    console.error("Error al obtener alumnos: ", e);
    throw e;
  }
};

const getAlumnoByIdFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_ALUMNOS_FIRESTORE, id);
    const docSnap = await window.getDoc(docRef);
    if (docSnap.exists()) {
      return { id: docSnap.id, ...docSnap.data() };
    } else {
      console.log("No existe tal documento de alumno!");
      return null;
    }
  } catch (e) {
    console.error("Error al obtener alumno por ID: ", e);
    throw e;
  }
};

const updateAlumnoFirestore = async (id, alumnoData) => {
  try {
    const docRef = window.doc(window.db, STORE_ALUMNOS_FIRESTORE, id);
    await window.updateDoc(docRef, alumnoData);
    console.log("Documento de alumno actualizado con ID: ", id);
  } catch (e) {
    console.error("Error al actualizar documento de alumno: ", e);
    throw e;
  }
};

const deleteAlumnoFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_ALUMNOS_FIRESTORE, id);
    await window.deleteDoc(docRef);
    console.log("Documento de alumno eliminado con ID: ", id);
  } catch (e) {
    console.error("Error al eliminar documento de alumno: ", e);
    throw e;
  }
};

// --- CUPOS (Firestore) ---
const addCupoFirestore = async (cupoData) => {
  try {
    const docRef = await window.addDoc(window.collection(window.db, STORE_CUPOS_FIRESTORE), cupoData);
    console.log("Documento de cupo escrito con ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Error al añadir documento de cupo: ", e);
    throw e;
  }
};

const getCuposFirestore = async () => {
  try {
    const querySnapshot = await window.getDocs(window.collection(window.db, STORE_CUPOS_FIRESTORE));
    const cupos = [];
    querySnapshot.forEach(doc => {
      cupos.push({ id: doc.id, ...doc.data() });
    });
    return cupos;
  } catch (e) {
    console.error("Error al obtener cupos: ", e);
    throw e;
  }
};

const getCupoByIdFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_CUPOS_FIRESTORE, id);
    const docSnap = await window.getDoc(docRef);
    if (docSnap.exists()) {
      return { id: docSnap.id, ...docSnap.data() };
    } else {
      console.log("No existe tal documento de cupo!");
      return null;
    }
  } catch (e) {
    console.error("Error al obtener cupo por ID: ", e);
    throw e;
  }
};

const updateCupoFirestore = async (id, cupoData) => {
  try {
    const docRef = window.doc(window.db, STORE_CUPOS_FIRESTORE, id);
    await window.updateDoc(docRef, cupoData);
    console.log("Documento de cupo actualizado con ID: ", id);
  } catch (e) {
    console.error("Error al actualizar documento de cupo: ", e);
    throw e;
  }
};

const deleteCupoFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_CUPOS_FIRESTORE, id);
    await window.deleteDoc(docRef);
    console.log("Documento de cupo eliminado con ID: ", id);
  } catch (e) {
    console.error("Error al eliminar documento de cupo: ", e);
    throw e;
  }
};

// --- PROFESORES (Firestore) ---
const addProfesorFirestore = async (profesorData) => {
  try {
    const docRef = await window.addDoc(window.collection(window.db, STORE_PROFESORES_FIRESTORE), profesorData);
    console.log("Documento de profesor escrito con ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Error al añadir documento de profesor: ", e);
    throw e;
  }
};

const getProfesoresFirestore = async () => {
  try {
    const querySnapshot = await window.getDocs(window.collection(window.db, STORE_PROFESORES_FIRESTORE));
    const profesores = [];
    querySnapshot.forEach(doc => {
      profesores.push({ id: doc.id, ...doc.data() });
    });
    return profesores;
  } catch (e) {
    console.error("Error al obtener profesores: ", e);
    throw e;
  }
};

const getProfesorByIdFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PROFESORES_FIRESTORE, id);
    const docSnap = await window.getDoc(docRef);
    if (docSnap.exists()) {
      return { id: docSnap.id, ...docSnap.data() };
    } else {
      console.log("No existe tal documento de profesor!");
      return null;
    }
  } catch (e) {
    console.error("Error al obtener profesor por ID: ", e);
    throw e;
  }
};

const updateProfesorFirestore = async (id, profesorData) => {
  try {
    const docRef = window.doc(window.db, STORE_PROFESORES_FIRESTORE, id);
    await window.updateDoc(docRef, profesorData);
    console.log("Documento de profesor actualizado con ID: ", id);
  } catch (e) {
    console.error("Error al actualizar documento de profesor: ", e);
    throw e;
  }
};

const deleteProfesorFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PROFESORES_FIRESTORE, id);
    await window.deleteDoc(docRef);
    console.log("Documento de profesor eliminado con ID: ", id);
  } catch (e) {
    console.error("Error al eliminar documento de profesor: ", e);
    throw e;
  }
};

// --- PLANTILLA ALUMNOS (Firestore) ---
const addPlantillaAlumnoFirestore = async (plantillaData) => {
  try {
    const docRef = await window.addDoc(window.collection(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE), plantillaData);
    console.log("Documento de plantilla de alumno escrito con ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Error al añadir documento de plantilla de alumno: ", e);
    throw e;
  }
};

const getPlantillaAlumnosFirestore = async () => {
  try {
    const querySnapshot = await window.getDocs(window.collection(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE));
    const plantillaAlumnos = [];
    querySnapshot.forEach(doc => {
      plantillaAlumnos.push({ id: doc.id, ...doc.data() });
    });
    return plantillaAlumnos;
  } catch (e) {
    console.error("Error al obtener plantilla de alumnos: ", e);
    throw e;
  }
};

const getPlantillaAlumnoByIdFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE, id);
    const docSnap = await window.getDoc(docRef);
    if (docSnap.exists()) {
      return { id: docSnap.id, ...docSnap.data() };
    } else {
      console.log("No existe tal documento de plantilla de alumno!");
      return null;
    }
  } catch (e) {
    console.error("Error al obtener plantilla de alumno por ID: ", e);
    throw e;
  }
};

const updatePlantillaAlumnoFirestore = async (id, plantillaData) => {
  try {
    const docRef = window.doc(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE, id);
    await window.updateDoc(docRef, plantillaData);
    console.log("Documento de plantilla de alumno actualizado con ID: ", id);
  } catch (e) {
    console.error("Error al actualizar documento de plantilla de alumno: ", e);
    throw e;
  }
};

const deletePlantillaAlumnoFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE, id);
    await window.deleteDoc(docRef);
    console.log("Documento de plantilla de alumno eliminado con ID: ", id);
  } catch (e) {
    console.error("Error al eliminar documento de plantilla de alumno: ", e);
    throw e;
  }
};

// --- PROYECTOS (Firestore) ---
const addProyectoFirestore = async (proyectoData) => {
  try {
    const docRef = await window.addDoc(window.collection(window.db, STORE_PROYECTOS_FIRESTORE), proyectoData);
    console.log("Documento de proyecto escrito con ID: ", docRef.id);
    return docRef.id;
  } catch (e) {
    console.error("Error al añadir documento de proyecto: ", e);
    throw e;
  }
};

const getProyectosFirestore = async () => {
  try {
    const querySnapshot = await window.getDocs(window.collection(window.db, STORE_PROYECTOS_FIRESTORE));
    const proyectos = [];
    querySnapshot.forEach(doc => {
      proyectos.push({ id: doc.id, ...doc.data() });
    });
    return proyectos;
  } catch (e) {
    console.error("Error al obtener proyectos: ", e);
    throw e;
  }
};

const getProyectoByIdFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PROYECTOS_FIRESTORE, id);
    const docSnap = await window.getDoc(docRef);
    if (docSnap.exists()) {
      return { id: docSnap.id, ...docSnap.data() };
    } else {
      console.log("No existe tal documento de proyecto!");
      return null;
    }
  } catch (e) {
    console.error("Error al obtener proyecto por ID: ", e);
    throw e;
  }
};

const updateProyectoFirestore = async (id, proyectoData) => {
  try {
    const docRef = window.doc(window.db, STORE_PROYECTOS_FIRESTORE, id);
    await window.updateDoc(docRef, proyectoData);
    console.log("Documento de proyecto actualizado con ID: ", id);
  } catch (e) {
    console.error("Error al actualizar documento de proyecto: ", e);
    throw e;
  }
};

const deleteProyectoFirestore = async (id) => {
  try {
    const docRef = window.doc(window.db, STORE_PROYECTOS_FIRESTORE, id);
    await window.deleteDoc(docRef);
    console.log("Documento de proyecto eliminado con ID: ", id);
  } catch (e) {
    console.error("Error al eliminar documento de proyecto: ", e);
    throw e;
  }
};


// Función para buscar en la plantilla por nombre o correo (Firestore)
const searchPlantillaAlumnosFirestore = async (queryText) => {
  try {
    // Para búsquedas de autocompletado, es común obtener todos los datos
    // y filtrar en el cliente si la colección no es demasiado grande.
    // Para colecciones muy grandes, se usarían consultas de Firestore con 'where'.
    const plantillaAlumnos = await getPlantillaAlumnosFirestore();
    const lowerCaseQuery = queryText.toLowerCase();
    const filtered = plantillaAlumnos.filter(alumno =>
      (alumno.nombre && alumno.nombre.toLowerCase().includes(lowerCaseQuery)) ||
      (alumno.correo && alumno.correo.toLowerCase().includes(lowerCaseQuery))
    );
    return filtered;
  } catch (e) {
    console.error("Error al buscar en plantilla de alumnos: ", e);
    throw e;
  }
};


// --- NOTIFICACIONES (TOASTS) ---
function showToast(message, type = 'info', title = 'Notificación') {
  const toastContainer = document.querySelector('.toast-container');
  const toastId = `toast-${Date.now()}`;
  const toastHtml = `
    <div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
      <div class="d-flex">
        <div class="toast-body">
          ${message}
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  `;
  toastContainer.insertAdjacentHTML('beforeend', toastHtml);
  const toastElement = document.getElementById(toastId);
  const toast = new bootstrap.Toast(toastElement);
  toast.show();

  toastElement.addEventListener('hidden.bs.toast', () => {
    toastElement.remove();
  });
}


// --- RENDER (ADAPTADO PARA FIRESTORE REALTIME LISTENERS) ---

// Variable para almacenar las fechas seleccionadas para un nuevo cupo
let fechasTemporalesCupo = [];

const renderFechasSeleccionadas = () => {
  const container = document.getElementById('fechasSeleccionadasContainer');
  container.innerHTML = '';
  if (fechasTemporalesCupo.length === 0) {
    container.innerHTML = '<small class="text-muted">No hay fechas seleccionadas.</small>';
  } else {
    fechasTemporalesCupo.sort().forEach(fecha => {
      container.innerHTML += `
        <span class="fecha-tag">
          ${fecha}
          <button type="button" class="btn-close-tag" onclick="removeFechaFromCupo('${fecha}')">x</button>
        </span>
      `;
    });
  }
  document.getElementById('fechasCupoHidden').value = fechasTemporalesCupo.join(',');
};

const addFechaToCupo = () => {
  const fechaInput = document.getElementById('fechaCupoIndividual');
  const fecha = fechaInput.value;
  if (fecha && !fechasTemporalesCupo.includes(fecha)) {
    fechasTemporalesCupo.push(fecha);
    renderFechasSeleccionadas();
    fechaInput.value = '';
  } else if (fecha && fechasTemporalesCupo.includes(fecha)) {
    showToast('Esta fecha ya ha sido añadida.', 'warning');
  } else {
    showToast('Por favor, seleccione una fecha.', 'warning');
  }
};

const removeFechaFromCupo = (fechaToRemove) => {
  fechasTemporalesCupo = fechasTemporalesCupo.filter(fecha => fecha !== fechaToRemove);
  renderFechasSeleccionadas();
};


// Listener en tiempo real para Profesores
const setupRealtimeProfesoresListener = () => {
  window.onSnapshot(window.collection(window.db, STORE_PROFESORES_FIRESTORE), (snapshot) => {
    const lista = document.getElementById('listaProfesores');
    lista.innerHTML = '';
    const profesorSelect = document.getElementById('profesorSelect');
    profesorSelect.innerHTML = '<option value="">Seleccione un profesor</option>';
    const reportProfesorFilter = document.getElementById('reportProfesorFilter');
    reportProfesorFilter.innerHTML = '<option value="">Todos</option>';

    if (snapshot.empty) {
      lista.innerHTML = '<tr><td colspan="4" class="text-center">No hay profesores registrados.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const p = { id: doc.id, ...doc.data() };
        lista.innerHTML += `<tr>
          <td>${p.nombre}</td>
          <td>${p.correo}</td>
          <td>${p.telefono || 'N/A'}</td>
          <td>
            <button class="btn btn-warning btn-sm me-2" onclick="editarProfesor('${p.id}')" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger btn-sm" onclick="eliminarProfesor('${p.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
          </td>
        </tr>`;
        profesorSelect.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
        reportProfesorFilter.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
      });
    }
    // Después de renderizar profesores, actualiza cupos y alumnos si es necesario
    // Estos listeners se llaman aquí para asegurar que los selects de profesor estén poblados
    // antes de que los cupos y alumnos intenten referenciarlos.
    setupRealtimeCuposListener();
    setupRealtimeAlumnosListener(); // Este listener también se encarga de actualizar el reporte
  }, (error) => {
    console.error("Error al escuchar cambios en profesores:", error);
    showToast("Error al cargar profesores en tiempo real.", 'danger');
  });
};

// Listener en tiempo real para Cupos
const setupRealtimeCuposListener = () => {
  window.onSnapshot(window.collection(window.db, STORE_CUPOS_FIRESTORE), async (snapshot) => {
    const lista = document.getElementById('listaCupos');
    const selectAlumnoCupoModal = document.getElementById('cupoSelectModal');
    lista.innerHTML = '';
    selectAlumnoCupoModal.innerHTML = '<option value="">Seleccione un horario</option>';

    const profesores = await getProfesoresFirestore(); // Obtener profesores para mostrar nombres

    if (snapshot.empty) {
      lista.innerHTML = '<tr><td colspan="5" class="text-center">No hay cupos disponibles.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const c = { id: doc.id, ...doc.data() };
        const profesor = profesores.find(p => p.id === c.profesorId);
        const nombreProfesor = profesor ? profesor.nombre : 'N/A';
        const fechasTexto = Array.isArray(c.fechas) ? c.fechas.join(', ') : c.fechas;

        lista.innerHTML += `<tr>
          <td>${nombreProfesor}</td>
          <td>${fechasTexto}</td>
          <td>${c.horaInicio} - ${c.horaFin}</td>
          <td>${c.disponibles}/${c.cupoMax}</td>
          <td><button class="btn btn-danger btn-sm" onclick="eliminarCupo('${c.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button></td>
        </tr>`;
        if (c.disponibles > 0) {
          selectAlumnoCupoModal.innerHTML += `<option value="${c.id}">${nombreProfesor} - ${fechasTexto} (${c.horaInicio}-${c.horaFin}) [${c.disponibles} disponibles]</option>`;
        }
      });
    }
    // Después de renderizar cupos, actualiza alumnos si es necesario
    // Esto asegura que la lista de alumnos refleje los cambios en los cupos.
    setupRealtimeAlumnosListener();
  }, (error) => {
    console.error("Error al escuchar cambios en cupos:", error);
    showToast("Error al cargar cupos en tiempo real.", 'danger');
  });
};

// Listener en tiempo real para Alumnos
const setupRealtimeAlumnosListener = () => {
  window.onSnapshot(window.collection(window.db, STORE_ALUMNOS_FIRESTORE), async (snapshot) => {
    const lista = document.getElementById('listaAlumnos');
    lista.innerHTML = '';

    const cupos = await getCuposFirestore();
    const profesores = await getProfesoresFirestore();
    const proyectos = await getProyectosFirestore();

    if (snapshot.empty) {
      lista.innerHTML = '<tr><td colspan="9" class="text-center">No hay alumnos inscritos.</td></tr>';
      document.getElementById('btnExportExcel').disabled = true;
      lastFilteredAlumnos = [];
      return;
    }

    snapshot.forEach(doc => {
      const a = { id: doc.id, ...doc.data() };

      const cupo = cupos.find(c => c.id === a.cupoId);
      let horarioTexto = 'N/A';
      if (cupo) {
        const profesor = profesores.find(p => p.id === cupo.profesorId);
        const nombreProfesor = profesor ? profesor.nombre : 'N/A';
        const fechasTexto = Array.isArray(cupo.fechas) ? cupo.fechas.join(', ') : cupo.fechas;
        horarioTexto = `${nombreProfesor} - ${fechasTexto} ${cupo.horaInicio}-${cupo.horaFin}`;
      }

      const proyectoAsignado = proyectos.find(p => p.id === a.proyectoId);
      const nombreProyectoAsignado = proyectoAsignado ? proyectoAsignado.nombre : 'Sin Proyecto';

      lista.innerHTML += `<tr>
        <td>${a.nombre}</td>
        <td>${a.nivel}</td>
        <td>${horarioTexto}</td>
        <td>${nombreProyectoAsignado}</td>
        <td>${a.pago || 'N/A'}</td>
        <td>${a.kit || 'N/A'}</td>
        <td>${a.observaciones || 'N/A'}</td>
        <td>${a.estatus}</td>
        <td>
          <button class="btn btn-warning btn-sm me-2" onclick="editarAlumno('${a.id}')" title="Editar Datos"><i class="fas fa-edit"></i></button>
          <button class="btn btn-info btn-sm me-2" onclick="abrirModalCambiarHorario('${a.id}')" title="Cambiar Horario"><i class="fas fa-calendar-check"></i></button>
          <button class="btn btn-primary btn-sm me-2" onclick="abrirModalAsignarProyecto('${a.id}')" title="Asignar Proyecto y Detalles"><i class="fas fa-project-diagram"></i></button>
          <button class="btn btn-danger btn-sm" onclick="eliminarAlumno('${a.id}','${a.cupoId}')" title="Eliminar Inscripción"><i class="fas fa-trash-alt"></i></button>
        </td>
      </tr>`;
    });
    applyReportFilters(); // Para actualizar el reporte con los nuevos datos
  }, (error) => {
    console.error("Error al escuchar cambios en alumnos:", error);
    showToast("Error al cargar alumnos en tiempo real.", 'danger');
  });
};

// Listener en tiempo real para Plantilla de Alumnos
const setupRealtimePlantillaAlumnosListener = () => {
  window.onSnapshot(window.collection(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE), (snapshot) => {
    const lista = document.getElementById('listaPlantillaAlumnos');
    lista.innerHTML = '';

    if (snapshot.empty) {
      lista.innerHTML = '<tr><td colspan="7" class="text-center">No hay alumnos registrados en la plantilla.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const p = { id: doc.id, ...doc.data() };
        const estadoClass = p.estado === 'Activo' ? 'badge bg-success' : 'badge bg-danger';
        lista.innerHTML += `<tr>
          <td>${p.nombre}</td>
          <td>${p.correo || 'N/A'}</td>
          <td>${p.telefono || 'N/A'}</td>
          <td>${p.nivel || 'N/A'}</td>
          <td>${p.observaciones || 'N/A'}</td>
          <td><span class="${estadoClass}">${p.estado || 'N/A'}</span></td>
          <td>
            <button class="btn btn-info btn-sm me-2" onclick="editarPlantillaAlumnoEstado('${p.id}')" title="Cambiar Estado"><i class="fas fa-toggle-on"></i></button>
            <button class="btn btn-danger btn-sm" onclick="eliminarPlantillaAlumno('${p.id}')" title="Eliminar de Plantilla"><i class="fas fa-user-times"></i></button>
          </td>
        </tr>`;
      });
    }
    autocomplete(document.getElementById("buscarAlumno")); // Actualiza el autocompletado
  }, (error) => {
    console.error("Error al escuchar cambios en plantilla de alumnos:", error);
    showToast("Error al cargar plantilla de alumnos en tiempo real.", 'danger');
  });
};

// Listener en tiempo real para Proyectos
const setupRealtimeProyectosListener = () => {
  window.onSnapshot(window.collection(window.db, STORE_PROYECTOS_FIRESTORE), (snapshot) => {
    const lista = document.getElementById('listaProyectos');
    lista.innerHTML = '';
    const proyectoSelectModal = document.getElementById('proyectoSelectModal');
    proyectoSelectModal.innerHTML = '<option value="">Sin Proyecto</option>';
    const reportProyectoFilter = document.getElementById('reportProyectoFilter');
    reportProyectoFilter.innerHTML = '<option value="">Todos</option>';

    if (snapshot.empty) {
      lista.innerHTML = '<tr><td colspan="2" class="text-center">No hay proyectos registrados.</td></tr>';
    } else {
      snapshot.forEach(doc => {
        const p = { id: doc.id, ...doc.data() };
        lista.innerHTML += `<tr>
          <td>${p.nombre}</td>
          <td>
            <button class="btn btn-warning btn-sm me-2" onclick="editarProyecto('${p.id}')" title="Editar"><i class="fas fa-edit"></i></button>
            <button class="btn btn-danger btn-sm" onclick="eliminarProyecto('${p.id}')" title="Eliminar"><i class="fas fa-trash-alt"></i></button>
          </td>
        </tr>`;
        proyectoSelectModal.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
        reportProyectoFilter.innerHTML += `<option value="${p.id}">${p.nombre}</option>`;
      });
    }
    // Después de renderizar proyectos, actualiza alumnos si es necesario
    // Esto asegura que la lista de alumnos refleje los cambios en los proyectos.
    setupRealtimeAlumnosListener();
    applyReportFilters(); // Para actualizar los filtros de reporte
  }, (error) => {
    console.error("Error al escuchar cambios en proyectos:", error);
    showToast("Error al cargar proyectos en tiempo real.", 'danger');
  });
};


// --- ACCIONES ALUMNOS (ADAPTADO PARA FIRESTORE) ---
async function eliminarAlumno(id, cupoId){
  if(confirm("¿Estás seguro de eliminar este alumno de la inscripción actual? Esto liberará su cupo.")){
    await deleteAlumnoFirestore(id); // Usa la función de Firestore
    if (cupoId) {
      const cupo = await getCupoByIdFirestore(cupoId); // Usa la función de Firestore
      if(cupo){
        cupo.disponibles++;
        await updateCupoFirestore(cupo.id, cupo); // Usa la función de Firestore
      }
    }
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Alumno eliminado de la inscripción actual exitosamente.", 'success');
  }
}

async function editarAlumno(id) {
  const alumno = await getAlumnoByIdFirestore(id); // Usa la función de Firestore
  if (!alumno) {
    showToast("Alumno no encontrado.", 'danger');
    return;
  }

  document.getElementById('nombre').value = alumno.nombre;
  document.getElementById('nivel').value = alumno.nivel;
  document.getElementById('telefono').value = alumno.telefono;
  document.getElementById('correo').value = alumno.correo;
  document.getElementById('estatus').value = alumno.estatus;
  document.getElementById('idAlumnoPlantilla').value = alumno.plantillaId || '';

  document.getElementById('idAlumnoEditando').value = alumno.id;
  document.getElementById('btnRegistrarAlumno').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
  document.getElementById('buscarAlumno').value = '';

  const tabRegistro = new bootstrap.Tab(document.getElementById('registro-tab'));
  tabRegistro.show();
}

function resetAlumnoForm() {
  document.getElementById('alumnoForm').reset();
  document.getElementById('idAlumnoEditando').value = '';
  document.getElementById('idAlumnoPlantilla').value = '';
  document.getElementById('btnRegistrarAlumno').innerHTML = '<i class="fas fa-save me-2"></i>Registrar Alumno';
  document.getElementById('buscarAlumno').value = '';
  closeAllLists();
}

let modalCambiarHorarioInstance;

async function abrirModalCambiarHorario(alumnoId) {
  const alumno = await getAlumnoByIdFirestore(alumnoId); // Usa la función de Firestore
  if (!alumno) {
    showToast("Alumno no encontrado.", 'danger');
    return;
  }

  document.getElementById('alumnoIdCambiarHorario').value = alumno.id;
  document.getElementById('nombreAlumnoCambiarHorario').textContent = alumno.nombre;

  // El select de cupos se actualiza automáticamente con setupRealtimeCuposListener
  document.getElementById('cupoSelectModal').value = alumno.cupoId || '';

  modalCambiarHorarioInstance = new bootstrap.Modal(document.getElementById('modalCambiarHorario'));
  modalCambiarHorarioInstance.show();
}

async function guardarCambioHorario() {
  const alumnoId = document.getElementById('alumnoIdCambiarHorario').value;
  const nuevoCupoId = document.getElementById('cupoSelectModal').value;

  if (!nuevoCupoId) {
    showToast("Por favor, seleccione un nuevo horario.", 'warning');
    return;
  }

  const alumno = await getAlumnoByIdFirestore(alumnoId);
  if (!alumno) {
    showToast("Error: Alumno no encontrado.", 'danger');
    return;
  }

  if (alumno.cupoId === nuevoCupoId) {
    showToast("El alumno ya está en este horario.", 'info');
    modalCambiarHorarioInstance.hide();
    return;
  }

  // Decrementar cupo anterior
  if (alumno.cupoId) {
    const cupoAnterior = await getCupoByIdFirestore(alumno.cupoId);
    if (cupoAnterior) {
      cupoAnterior.disponibles++;
      await updateCupoFirestore(cupoAnterior.id, cupoAnterior);
    }
  }

  // Incrementar nuevo cupo
  const nuevoCupo = await getCupoByIdFirestore(nuevoCupoId);
  if (!nuevoCupo || nuevoCupo.disponibles <= 0) {
    showToast("El nuevo horario seleccionado está lleno o no existe.", 'danger');
    // Revertir el decremento si el nuevo cupo falla
    if (alumno.cupoId) {
      const cupoAnteriorRevert = await getCupoByIdFirestore(alumno.cupoId);
      if (cupoAnteriorRevert) {
        cupoAnteriorRevert.disponibles--;
        await updateCupoFirestore(cupoAnteriorRevert.id, cupoAnteriorRevert);
      }
    }
    return;
  }
  nuevoCupo.disponibles--;
  await updateCupoFirestore(nuevoCupo.id, nuevoCupo);

  // Actualizar alumno
  alumno.cupoId = nuevoCupoId;
  await updateAlumnoFirestore(alumno.id, alumno);

  showToast(`Horario de ${alumno.nombre} actualizado exitosamente.`, 'success');
  modalCambiarHorarioInstance.hide();

  // Los listeners de onSnapshot se encargarán de renderizar la UI
}

let modalAsignarProyectoInstance;

async function abrirModalAsignarProyecto(alumnoId) {
  const alumno = await getAlumnoByIdFirestore(alumnoId);
  if (!alumno) {
    showToast("Alumno no encontrado.", 'danger');
    return;
  }

  document.getElementById('alumnoIdAsignarProyecto').value = alumno.id;
  document.getElementById('nombreAlumnoAsignarProyecto').textContent = alumno.nombre;

  // El select de proyectos se actualiza automáticamente con setupRealtimeProyectosListener
  const proyectoSelectModal = document.getElementById('proyectoSelectModal');
  proyectoSelectModal.value = alumno.proyectoId || '';
  document.getElementById('pagoSelectModal').value = alumno.pago || '';
  document.getElementById('kitSelectModal').value = alumno.kit || '';
  document.getElementById('observacionesModal').value = alumno.observaciones || '';

  modalAsignarProyectoInstance = new bootstrap.Modal(document.getElementById('modalAsignarProyecto'));
  modalAsignarProyectoInstance.show();
}

async function guardarProyectoAlumno() {
  const alumnoId = document.getElementById('alumnoIdAsignarProyecto').value;
  const nuevoProyectoId = document.getElementById('proyectoSelectModal').value;
  const nuevoPago = document.getElementById('pagoSelectModal').value;
  const nuevoKit = document.getElementById('kitSelectModal').value;
  const nuevasObservaciones = document.getElementById('observacionesModal').value.trim();

  const alumno = await getAlumnoByIdFirestore(alumnoId);
  if (!alumno) {
    showToast("Error: Alumno no encontrado.", 'danger');
    return;
  }

  alumno.proyectoId = nuevoProyectoId || null;
  alumno.pago = nuevoPago;
  alumno.kit = nuevoKit;
  alumno.observaciones = nuevasObservaciones;
  await updateAlumnoFirestore(alumno.id, alumno);

  const nombreProyecto = nuevoProyectoId ? (await getProyectoByIdFirestore(nuevoProyectoId)).nombre : 'Sin Proyecto';
  showToast(`Proyecto y detalles de ${alumno.nombre} actualizados a "${nombreProyecto}" exitosamente.`, 'success');
  modalAsignarProyectoInstance.hide();

  // Los listeners de onSnapshot se encargarán de renderizar la UI
}


// --- ACCIONES CUPOS (ADAPTADO PARA FIRESTORE) ---
async function eliminarCupo(id){
  const alumnos=await getAlumnosFirestore();
  if(alumnos.some(a=>a.cupoId===id)){
    showToast("No se puede eliminar un cupo con alumnos asignados. Por favor, reasigne o elimine los alumnos de este cupo primero.", 'danger');
    return;
  }
  if(confirm("¿Estás seguro de eliminar este cupo? Esta acción no se puede deshacer.")){
    await deleteCupoFirestore(id);
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Cupo eliminado exitosamente.", 'success');
  }
}

// --- ACCIONES PROFESORES (ADAPTADO PARA FIRESTORE) ---
async function editarProfesor(id) {
  const profesor = await getProfesorByIdFirestore(id);
  if (!profesor) {
    showToast("Profesor no encontrado.", 'danger');
    return;
  }

  document.getElementById('nombreProfesor').value = profesor.nombre;
  document.getElementById('correoProfesor').value = profesor.correo;
  document.getElementById('telefonoProfesor').value = profesor.telefono;

  document.getElementById('idProfesorEditando').value = profesor.id;
  document.getElementById('btnRegistrarProfesor').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';

  const tabProfesores = new bootstrap.Tab(document.getElementById('profesores-tab'));
  tabProfesores.show();
}

async function eliminarProfesor(id) {
  const cupos = await getCuposFirestore();
  if (cupos.some(c => c.profesorId === id)) {
    showToast("No se puede eliminar un profesor que tiene cupos asignados. Elimine los cupos de este profesor primero.", 'danger');
    return;
  }
  if (confirm("¿Estás seguro de eliminar este profesor? Esta acción no se puede deshacer.")) {
    await deleteProfesorFirestore(id);
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Profesor eliminado exitosamente.", 'success');
  }
}

function resetProfesorForm() {
  document.getElementById('profesorForm').reset();
  document.getElementById('idProfesorEditando').value = '';
  document.getElementById('btnRegistrarProfesor').innerHTML = '<i class="fas fa-user-plus me-2"></i>Registrar Profesor';
}

// --- ACCIONES PLANTILLA ALUMNOS (ADAPTADO PARA FIRESTORE) ---
async function editarPlantillaAlumnoEstado(id) {
  const alumnoPlantilla = await getPlantillaAlumnoByIdFirestore(id);
  if (!alumnoPlantilla) {
    showToast("Alumno de plantilla no encontrado.", 'danger');
    return;
  }

  const nuevoEstado = alumnoPlantilla.estado === 'Activo' ? 'Inactivo' : 'Activo';
  if (confirm(`¿Cambiar el estado de ${alumnoPlantilla.nombre} a "${nuevoEstado}"?`)) {
    alumnoPlantilla.estado = nuevoEstado;
    await updatePlantillaAlumnoFirestore(alumnoPlantilla.id, alumnoPlantilla);
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast(`Estado de ${alumnoPlantilla.nombre} actualizado a "${nuevoEstado}".`, 'success');
  }
}

async function eliminarPlantillaAlumno(id) {
  if (confirm("¿Estás seguro de eliminar este alumno de la plantilla? Esto no afectará a los alumnos actualmente inscritos, pero no podrá ser buscado para futuras reinscripciones.")) {
    await deletePlantillaAlumnoFirestore(id);
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Alumno eliminado de la plantilla exitosamente.", 'success');
  }
}

// --- ACCIONES PROYECTOS (ADAPTADO PARA FIRESTORE) ---
async function editarProyecto(id) {
  const proyecto = await getProyectoByIdFirestore(id);
  if (!proyecto) {
    showToast("Proyecto no encontrado.", 'danger');
    return;
  }

  document.getElementById('nombreProyecto').value = proyecto.nombre;

  document.getElementById('idProyectoEditando').value = proyecto.id;
  document.getElementById('btnRegistrarProyecto').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';

  const tabProyectos = new bootstrap.Tab(document.getElementById('proyectos-tab'));
  tabProyectos.show();
}

async function eliminarProyecto(id) {
  const alumnos = await getAlumnosFirestore();
  if (alumnos.some(a => a.proyectoId === id)) {
    showToast("No se puede eliminar un proyecto que tiene alumnos asignados. Por favor, desasigne los alumnos de este proyecto primero.", 'danger');
    return;
  }

  if (confirm("¿Estás seguro de eliminar este proyecto? Esta acción no se puede deshacer.")) {
    await deleteProyectoFirestore(id);
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Proyecto eliminado exitosamente.", 'success');
  }
}

function resetProyectoForm() {
  document.getElementById('proyectoForm').reset();
  document.getElementById('idProyectoEditando').value = '';
  document.getElementById('btnRegistrarProyecto').innerHTML = '<i class="fas fa-save me-2"></i>Registrar Proyecto';
}


// --- Autocompletado para buscar alumnos (ADAPTADO PARA FIRESTORE) ---
let currentFocus;

function autocomplete(inp) {
  inp.addEventListener("input", async function(e) {
    let a, b, i, val = this.value;
    closeAllLists();
    if (!val) { return false;}
    currentFocus = -1;
    a = document.getElementById("autocompleteList");
    if (!a) {
      a = document.createElement("DIV");
      a.setAttribute("id", "autocompleteList");
      a.setAttribute("class", "autocomplete-items");
      this.parentNode.appendChild(a);
    }

    const filteredArr = await searchPlantillaAlumnosFirestore(val);

    for (i = 0; i < filteredArr.length; i++) {
      b = document.createElement("DIV");
      let displayHtml = "<strong>" + filteredArr[i].nombre.substr(0, val.length) + "</strong>";
      displayHtml += filteredArr[i].nombre.substr(val.length);
      displayHtml += " <small class='text-muted'>(" + filteredArr[i].correo + ")</small>";

      if (filteredArr[i].estado === 'Inactivo') {
        displayHtml += " <span class='badge bg-danger ms-2'>Inactivo</span>";
      }

      b.innerHTML = displayHtml;
      b.innerHTML += "<input type='hidden' value='" + filteredArr[i].id + "'>";
      b.addEventListener("click", async function(e) {
          const plantillaId = this.getElementsByTagName("input")[0].value;
          const alumnoPlantilla = await getPlantillaAlumnoByIdFirestore(plantillaId);
          if (alumnoPlantilla) {
              if (alumnoPlantilla.estado === 'Inactivo') {
                  if (confirm(`El alumno ${alumnoPlantilla.nombre} está INACTIVO. ¿Desea activarlo para reinscribirlo?`)) {
                      alumnoPlantilla.estado = 'Activo';
                      await updatePlantillaAlumnoFirestore(plantillaId, alumnoPlantilla);
                      showToast(`${alumnoPlantilla.nombre} ha sido activado.`, 'success');
                      // Los listeners de onSnapshot se encargarán de renderizar la UI
                  } else {
                      closeAllLists();
                      return;
                  }
              }

              document.getElementById('nombre').value = alumnoPlantilla.nombre;
              document.getElementById('nivel').value = alumnoPlantilla.nivel;
              document.getElementById('telefono').value = alumnoPlantilla.telefono;
              document.getElementById('correo').value = alumnoPlantilla.correo;
              document.getElementById('estatus').value = 'Recurrente';
              document.getElementById('idAlumnoPlantilla').value = alumnoPlantilla.id;
              document.getElementById('buscarAlumno').value = alumnoPlantilla.nombre;
              document.getElementById('idAlumnoEditando').value = '';
              document.getElementById('btnRegistrarAlumno').innerHTML = '<i class="fas fa-save me-2"></i>Registrar Alumno';
          }
          closeAllLists();
      });
      a.appendChild(b);
    }
  });

  inp.addEventListener("keydown", function(e) {
    let x = document.getElementById("autocompleteList");
    if (x) x = x.getElementsByTagName("div");
    if (e.keyCode == 40) {
      currentFocus++;
      addActive(x);
    } else if (e.keyCode == 38) {
      currentFocus--;
      addActive(x);
    } else if (e.keyCode == 13) {
      e.preventDefault();
      if (currentFocus > -1) {
        if (x) x[currentFocus].click();
      }
    }
  });

  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
  }

  function removeActive(x) {
    for (let i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }

  function closeAllLists(elmnt) {
    const x = document.getElementsByClassName("autocomplete-items");
    for (let i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }

  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
  });
}

// --- REPORTES (ADAPTADO PARA FIRESTORE) ---
async function populateReportFilters() {
  // Estos filtros se actualizan automáticamente con los listeners de profesores y proyectos
  // No es necesario llamar a getProfesoresFirestore() o getProyectosFirestore() aquí directamente
  // ya que los listeners ya los poblaron.
}

async function renderReportes() {
  await populateReportFilters(); // Esto solo actualiza los selects de filtro
  await applyReportFilters(); // Esto genera el reporte basado en los filtros actuales
}

async function applyReportFilters() {
  const filterProfesorId = document.getElementById('reportProfesorFilter').value;
  const filterProyectoId = document.getElementById('reportProyectoFilter').value;
  const filterNivel = document.getElementById('reportNivelFilter').value;
  const filterEstatus = document.getElementById('reportEstatusFilter').value;
  const filterPago = document.getElementById('reportPagoFilter').value;
  const filterKit = document.getElementById('reportKitFilter').value;

  const allAlumnos = await getAlumnosFirestore();
  const allCupos = await getCuposFirestore();
  const allProfesores = await getProfesoresFirestore();
  const allProyectos = await getProyectosFirestore();

  let filteredAlumnos = allAlumnos.filter(alumno => {
    let matches = true;

    // Filtrar por Profesor
    if (filterProfesorId) {
      const cupo = allCupos.find(c => c.id === alumno.cupoId);
      if (!cupo || cupo.profesorId !== filterProfesorId) {
        matches = false;
      }
    }

    // Filtrar por Proyecto
    if (filterProyectoId) {
      if (alumno.proyectoId !== filterProyectoId) {
        matches = false;
      }
    }

    // Filtrar por Nivel
    if (filterNivel && alumno.nivel !== filterNivel) {
      matches = false;
    }

    // Filtrar por Estatus
    if (filterEstatus && alumno.estatus !== filterEstatus) {
      matches = false;
    }

    // Filtrar por Pago
    if (filterPago) {
      if (filterPago === 'N/A') {
        if (alumno.pago !== '' && alumno.pago !== undefined && alumno.pago !== null) {
          matches = false;
        }
      } else if (alumno.pago !== filterPago) {
        matches = false;
      }
    }

    // Filtrar por Kit
    if (filterKit) {
      if (filterKit === 'N/A') {
        if (alumno.kit !== '' && alumno.kit !== undefined && alumno.kit !== null) {
          matches = false;
        }
      } else if (alumno.kit !== filterKit) {
        matches = false;
      }
    }

    return matches;
  });

  const reportResultsBody = document.getElementById('reportResults');
  reportResultsBody.innerHTML = '';

  lastFilteredAlumnos = [];

  if (filteredAlumnos.length === 0) {
    reportResultsBody.innerHTML = '<tr><td colspan="8" class="text-center">No hay alumnos que coincidan con los filtros aplicados.</td></tr>';
    document.getElementById('btnExportExcel').disabled = true;
  } else {
    for (const alumno of filteredAlumnos) {
      const cupo = allCupos.find(c => c.id === alumno.cupoId);
      let horarioTexto = 'N/A';
      let profesorNombre = 'N/A';
      if (cupo) {
        const profesor = allProfesores.find(p => p.id === cupo.profesorId);
        profesorNombre = profesor ? profesor.nombre : 'N/A';
        const fechasTexto = Array.isArray(cupo.fechas) ? cupo.fechas.join(', ') : cupo.fechas;
        horarioTexto = `${profesorNombre} - ${fechasTexto} ${cupo.horaInicio}-${cupo.horaFin}`;
      }

      const proyectoAsignado = allProyectos.find(p => p.id === alumno.proyectoId);
      const nombreProyectoAsignado = proyectoAsignado ? proyectoAsignado.nombre : 'Sin Proyecto';

      reportResultsBody.innerHTML += `<tr>
        <td>${alumno.nombre}</td>
        <td>${alumno.nivel}</td>
        <td>${horarioTexto}</td>
        <td>${nombreProyectoAsignado}</td>
        <td>${alumno.pago || 'N/A'}</td>
        <td>${alumno.kit || 'N/A'}</td>
        <td>${alumno.observaciones || 'N/A'}</td>
        <td>${alumno.estatus}</td>
      </tr>`;

      lastFilteredAlumnos.push({
        Nombre: alumno.nombre,
        Nivel: alumno.nivel,
        Horario: horarioTexto,
        Profesor: profesorNombre,
        'Proyecto Asignado': nombreProyectoAsignado,
        Pago: alumno.pago || 'N/A',
        Kit: alumno.kit || 'N/A',
        Observaciones: alumno.observaciones || 'N/A',
        Estatus: alumno.estatus
      });
    }
    document.getElementById('btnExportExcel').disabled = false;
  }
}

// --- FUNCIONES DE EXPORTACIÓN (ADAPTADO PARA FIRESTORE) ---
async function exportToExcel() {
  if (lastFilteredAlumnos.length === 0) {
    showToast("No hay datos en el reporte para exportar a Excel.", 'warning');
    return;
  }

  const wb = XLSX.utils.book_new();
  const ws_data = XLSX.utils.json_to_sheet(lastFilteredAlumnos);
  XLSX.utils.book_append_sheet(wb, ws_data, "Alumnos Filtrados");
  XLSX.writeFile(wb, "Reporte_Alumnos.xlsx");
  showToast("Reporte exportado a Excel exitosamente.", 'success');
}

async function exportToJson() {
  const allData = {
    alumnos: await getAlumnosFirestore(),
    cupos: await getCuposFirestore(),
    profesores: await getProfesoresFirestore(),
    plantillaAlumnos: await getPlantillaAlumnosFirestore(),
    proyectos: await getProyectosFirestore()
  };

  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  const exportFileDefaultName = 'backup_sistema_alumnos.json';

  let linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();

  showToast("Datos del sistema exportados a JSON exitosamente.", 'success');
}

async function importJson(event) {
  const file = event.target.files[0];
  if (!file) {
    showToast("No se seleccionó ningún archivo.", 'warning');
    return;
  }

  if (!confirm("¡ADVERTENCIA! Importar un archivo JSON SOBRESCRIBIRÁ TODOS los datos existentes en el sistema (alumnos, cupos, profesores, etc.). ¿Está seguro de que desea continuar?")) {
    event.target.value = '';
    return;
  }

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const importedData = JSON.parse(e.target.result);

      const expectedStores = [STORE_ALUMNOS_FIRESTORE, STORE_CUPOS_FIRESTORE, STORE_PROFESORES_FIRESTORE, STORE_PLANTILLA_ALUMNOS_FIRESTORE, STORE_PROYECTOS_FIRESTORE];
      for (const storeName of expectedStores) {
        if (!Array.isArray(importedData[storeName])) {
          showToast(`El archivo JSON no tiene el formato esperado. Falta o es incorrecta la sección: ${storeName}`, 'danger');
          event.target.value = '';
          return;
        }
      }

      showToast("Borrando datos existentes...", 'info');
      // Borrar datos existentes en cada colección
      await Promise.all(expectedStores.map(async (storeName) => {
        const querySnapshot = await window.getDocs(window.collection(window.db, storeName));
        const deleteBatch = window.db.batch();
        querySnapshot.forEach(doc => {
          deleteBatch.delete(window.doc(window.db, storeName, doc.id));
        });
        await deleteBatch.commit();
      }));
      showToast("Datos existentes borrados. Importando nuevos datos...", 'info');

      const batch = window.db.batch();

      // Mapeos para IDs originales a nuevos IDs de Firestore
      const profesorIdMap = new Map();
      const cupoIdMap = new Map();
      const proyectoIdMap = new Map();
      const plantillaIdMap = new Map();

      // 1. Añadir Profesores
      for (const item of importedData[STORE_PROFESORES_FIRESTORE]) {
        const originalId = item.id;
        delete item.id;
        const newDocRef = window.doc(window.collection(window.db, STORE_PROFESORES_FIRESTORE));
        batch.set(newDocRef, item);
        profesorIdMap.set(originalId, newDocRef.id);
      }

      // 2. Añadir Proyectos
      for (const item of importedData[STORE_PROYECTOS_FIRESTORE]) {
        const originalId = item.id;
        delete item.id;
        const newDocRef = window.doc(window.collection(window.db, STORE_PROYECTOS_FIRESTORE));
        batch.set(newDocRef, item);
        proyectoIdMap.set(originalId, newDocRef.id);
      }

      // 3. Añadir Plantilla Alumnos
      for (const item of importedData[STORE_PLANTILLA_ALUMNOS_FIRESTORE]) {
        const originalId = item.id;
        delete item.id;
        const newDocRef = window.doc(window.collection(window.db, STORE_PLANTILLA_ALUMNOS_FIRESTORE));
        batch.set(newDocRef, item);
        plantillaIdMap.set(originalId, newDocRef.id);
      }

      // 4. Añadir Cupos (actualizando profesorId)
      for (const item of importedData[STORE_CUPOS_FIRESTORE]) {
        const originalId = item.id;
        if (item.profesorId !== undefined && profesorIdMap.has(item.profesorId)) {
          item.profesorId = profesorIdMap.get(item.profesorId);
        } else if (item.profesorId !== undefined && item.profesorId !== null) {
          console.warn(`Profesor con ID original ${item.profesorId} no encontrado en el mapeo para cupo ${originalId}. Asignando null.`);
          item.profesorId = null;
        }
        delete item.id;
        const newDocRef = window.doc(window.collection(window.db, STORE_CUPOS_FIRESTORE));
        batch.set(newDocRef, item);
        cupoIdMap.set(originalId, newDocRef.id);
      }

      // 5. Añadir Alumnos (actualizando cupoId, proyectoId, plantillaId)
      for (const item of importedData[STORE_ALUMNOS_FIRESTORE]) {
        if (item.cupoId !== undefined && cupoIdMap.has(item.cupoId)) {
          item.cupoId = cupoIdMap.get(item.cupoId);
        } else if (item.cupoId !== undefined && item.cupoId !== null) {
          console.warn(`Cupo con ID original ${item.cupoId} no encontrado en el mapeo para alumno ${item.nombre}. Asignando null.`);
          item.cupoId = null;
        }
        if (item.proyectoId !== undefined && proyectoIdMap.has(item.proyectoId)) {
          item.proyectoId = proyectoIdMap.get(item.proyectoId);
        } else if (item.proyectoId !== undefined && item.proyectoId !== null) {
          console.warn(`Proyecto con ID original ${item.proyectoId} no encontrado en el mapeo para alumno ${item.nombre}. Asignando null.`);
          item.proyectoId = null;
        }
        if (item.plantillaId !== undefined && plantillaIdMap.has(item.plantillaId)) {
          item.plantillaId = plantillaIdMap.get(item.plantillaId);
        } else if (item.plantillaId !== undefined && item.plantillaId !== null) {
          console.warn(`Plantilla con ID original ${item.plantillaId} no encontrado en el mapeo para alumno ${item.nombre}. Asignando null.`);
          item.plantillaId = null;
        }
        delete item.id;
        const newDocRef = window.doc(window.collection(window.db, STORE_ALUMNOS_FIRESTORE));
        batch.set(newDocRef, item);
      }

      await batch.commit(); // Ejecuta todas las operaciones del batch

      showToast("Datos importados exitosamente. Recargando el sistema...", 'success');
      // Los listeners de onSnapshot se encargarán de actualizar la UI
      event.target.value = '';

    } catch (error) {
      showToast(`Error al leer o parsear el archivo JSON o al importar datos: ${error.message}`, 'danger');
      console.error("Error de importación:", error);
      event.target.value = '';
    }
  };
  reader.readAsText(file);
}


// --- EVENTOS ---
document.addEventListener('DOMContentLoaded',async()=>{
  // Elimina la llamada a openDB() si ya no usas IndexedDB
  // await openDB();

  // Inicia los listeners en tiempo real para tus colecciones
  // Es importante que los listeners se llamen en un orden que tenga sentido
  // Por ejemplo, profesores antes que cupos, y cupos antes que alumnos.
  setupRealtimeProfesoresListener();
  setupRealtimeProyectosListener(); // Proyectos también puede ir antes de alumnos
  setupRealtimePlantillaAlumnosListener();
  // setupRealtimeCuposListener() y setupRealtimeAlumnosListener()
  // se llaman dentro de los listeners de profesores y proyectos para asegurar
  // que los datos relacionados estén disponibles.

  renderFechasSeleccionadas(); // Esto no depende de la DB, solo de fechasTemporalesCupo

  autocomplete(document.getElementById("buscarAlumno"));

  document.getElementById('alumnoForm').addEventListener('submit',async e=>{
    e.preventDefault();

    const idAlumnoEditando = document.getElementById('idAlumnoEditando').value;
    let idAlumnoPlantilla = document.getElementById('idAlumnoPlantilla').value;

    let alumnoData = {
      nombre: nombre.value,
      nivel: nivel.value,
      telefono: telefono.value,
      correo: correo.value,
      estatus: estatus.value,
      observaciones: '',
      pago: '',
      kit: '',
      cupoId: null,
      proyectoId: null,
      plantillaId: idAlumnoPlantilla || null // Firestore IDs son strings
    };

    let plantillaData = {
      nombre: nombre.value,
      telefono: telefono.value,
      correo: correo.value,
      nivel: nivel.value,
      observaciones: '',
      estado: 'Activo'
    };

    if (idAlumnoEditando) {
      // EDITAR ALUMNO EXISTENTE
      const alumnoOriginal = await getAlumnoByIdFirestore(idAlumnoEditando);
      if (!alumnoOriginal) {
        showToast("Error: Alumno original no encontrado para edición.", 'danger');
        return;
      }

      // Mantener los campos que no se editan en este formulario
      alumnoData.cupoId = alumnoOriginal.cupoId;
      alumnoData.proyectoId = alumnoOriginal.proyectoId;
      alumnoData.observaciones = alumnoOriginal.observaciones;
      alumnoData.pago = alumnoOriginal.pago;
      alumnoData.kit = alumnoOriginal.kit;
      alumnoData.plantillaId = alumnoOriginal.plantillaId;

      await updateAlumnoFirestore(idAlumnoEditando, alumnoData);
      showToast("Datos del alumno actualizados exitosamente.", 'success');

      // Lógica para actualizar la plantilla
      if (idAlumnoPlantilla) {
        plantillaData.observaciones = alumnoOriginal.observaciones;
        await updatePlantillaAlumnoFirestore(idAlumnoPlantilla, plantillaData);
      } else {
        const existingPlantilla = (await getPlantillaAlumnosFirestore()).find(p => p.correo === plantillaData.correo);
        if (existingPlantilla) {
          plantillaData.observaciones = existingPlantilla.observaciones; // Mantener observaciones de plantilla si existe
          await updatePlantillaAlumnoFirestore(existingPlantilla.id, plantillaData);
          alumnoData.plantillaId = existingPlantilla.id;
          await updateAlumnoFirestore(idAlumnoEditando, alumnoData);
        } else {
          const newPlantillaId = await addPlantillaAlumnoFirestore(plantillaData);
          alumnoData.plantillaId = newPlantillaId;
          await updateAlumnoFirestore(idAlumnoEditando, alumnoData);
        }
      }

    } else {
      // REGISTRAR NUEVO ALUMNO
      if (!idAlumnoPlantilla) {
        const existingPlantilla = (await getPlantillaAlumnosFirestore()).find(p => p.correo === plantillaData.correo);
        if (existingPlantilla) {
          plantillaData.observaciones = existingPlantilla.observaciones; // Mantener observaciones de plantilla si existe
          await updatePlantillaAlumnoFirestore(existingPlantilla.id, plantillaData);
          alumnoData.plantillaId = existingPlantilla.id;
        } else {
          const newPlantillaId = await addPlantillaAlumnoFirestore(plantillaData);
          alumnoData.plantillaId = newPlantillaId;
        }
      }

      await addAlumnoFirestore(alumnoData);
      showToast("Alumno registrado exitosamente. Asigne un horario y proyecto desde la pestaña 'Alumnos Inscritos'.", 'success');
    }

    resetAlumnoForm();
    // Los listeners de onSnapshot se encargarán de renderizar la UI
  });

  document.getElementById('btnLimpiarAlumnoForm').addEventListener('click', () => {
    resetAlumnoForm();
  });

  document.getElementById('btnAddFechaCupo').addEventListener('click', addFechaToCupo);

  document.getElementById('cupoForm').addEventListener('submit',async e=>{
    e.preventDefault();
    const profesorId = document.getElementById('profesorSelect').value;
    if (!profesorId) {
      showToast("Seleccione un profesor válido.", 'warning');
      return;
    }
    if (fechasTemporalesCupo.length === 0) {
      showToast("Debe añadir al menos una fecha para el cupo.", 'warning');
      return;
    }

    const c={
      profesorId: profesorId,
      fechas: fechasTemporalesCupo,
      horaInicio:horaInicio.value,
      horaFin:horaFin.value,
      cupoMax:parseInt(cupoMax.value),
      disponibles:parseInt(cupoMax.value)
    };
    await addCupoFirestore(c);
    e.target.reset();
    fechasTemporalesCupo = [];
    renderFechasSeleccionadas();
    // Los listeners de onSnapshot se encargarán de renderizar la UI
    showToast("Cupo registrado exitosamente.", 'success');
  });

  document.getElementById('profesorForm').addEventListener('submit', async e => {
    e.preventDefault();
    const idProfesorEditando = document.getElementById('idProfesorEditando').value;
    let profesorData = {
      nombre: nombreProfesor.value,
      correo: correoProfesor.value,
      telefono: telefonoProfesor.value
    };

    if (idProfesorEditando) {
      await updateProfesorFirestore(idProfesorEditando, profesorData);
      showToast("Profesor actualizado exitosamente.", 'success');
    } else {
      await addProfesorFirestore(profesorData);
      showToast("Profesor registrado exitosamente.", 'success');
    }

    resetProfesorForm();
    // Los listeners de onSnapshot se encargarán de renderizar la UI
  });

  document.getElementById('proyectoForm').addEventListener('submit', async e => {
    e.preventDefault();
    const idProyectoEditando = document.getElementById('idProyectoEditando').value;
    let proyectoData = {
      nombre: nombreProyecto.value,
    };

    if (idProyectoEditando) {
      await updateProyectoFirestore(idProyectoEditando, proyectoData);
      showToast("Proyecto actualizado exitosamente.", 'success');
    } else {
      await addProyectoFirestore(proyectoData);
      showToast("Proyecto registrado exitosamente.", 'success');
    }

    resetProyectoForm();
    // Los listeners de onSnapshot se encargarán de renderizar la UI
  });

  document.getElementById('btnGuardarCambioHorario').addEventListener('click', guardarCambioHorario);

  document.getElementById('btnGuardarProyecto').addEventListener('click', guardarProyectoAlumno);

  // Evento para la pestaña de reportes
  document.getElementById('reportes-tab').addEventListener('shown.bs.tab', renderReportes);
  document.getElementById('btnApplyReportFilters').addEventListener('click', applyReportFilters);
  document.getElementById('btnExportExcel').addEventListener('click', exportToExcel);
  document.getElementById('btnExportJson').addEventListener('click', exportToJson);

  // Eventos para importar JSON
  document.getElementById('btnImportJson').addEventListener('click', () => {
    document.getElementById('jsonFileInput').click();
  });
  document.getElementById('jsonFileInput').addEventListener('change', importJson);
});
</script>
</body>
</html>
